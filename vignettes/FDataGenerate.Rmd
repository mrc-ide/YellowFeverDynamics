---
title: "Vignette 6 - Generating Epidemiological Data Sets"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette 6 - Generating Epidemiological Data Sets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette demonstrates how to use the package to generate a set of epidemiological data (serological, annual reported severe/fatal cases and/or annual outbreak occurence) for specified time periods and regions (and age ranges, in the case of serological data). This can either be set up to match a set of observed data or to create a hypothetical set of data with no existing counterpart (by matching to "dummy" data).

First load the package:

```{r}
library(YellowFeverDynamics)
```

Next the input data set, regional environmental covariate values, coefficients of environmental covariate values used to calculate spillover FOI and R0 values, and observed serological and annual case data (here generated by the model itself) are loaded.

```{r}
input_data <- readRDS(file=paste(path.package("YellowFeverDynamics"),"/exdata/input_data_example.Rds",sep=""))
enviro_data <- read.csv(file = paste(path.package("YellowFeverDynamics"),"/exdata/enviro_data_example.csv",sep = ""),header = TRUE)
enviro_coeffs <- read.csv(file = paste(path.package("YellowFeverDynamics"),"/exdata/enviro_coeffs_example.csv",sep = ""),header = TRUE)
obs_sero_data <- read.csv(file=paste(path.package("YellowFeverDynamics"),"/exdata/sero_data_example_single.csv",sep=""),header=TRUE)    
                      # Seroprevalence data for comparison, by region, year & age group, in format no. samples/no. positives
obs_case_data <- read.csv(file=paste(path.package("YellowFeverDynamics"),"/exdata/case_data_example_single.csv",sep=""),header=TRUE)    
                      # Annual reported case/death data for comparison, by region and year, in format no. cases/no. deaths
```

Additional inputs for the data_match_single() function, which is used to generate model data to match observed or dummy data, are set as follows:

```{r}
param_prop <- as.numeric(enviro_coeffs)
                      # Parameters input to produce model parameters, potentially including spillover FOI and R0 by region, severe and fatal case reporting probability
obs_outbreak_data <- NULL
                      # Outbreak Y/N data for comparison, by region and year, in format 0 = no outbreaks, 1 = 1 or more outbreak(s) (here simply set to NULL)
const_list <- list(type="FOI+R0 enviro",n_reps=1,mode_start=1,dt=1.0,enviro_data=enviro_data,R0_fixed_values=NULL,vaccine_efficacy=1.0,p_rep_severe=0.05,p_rep_death=0.1)
                      # List containing additional parameters: type of parameter set used to calculate spillover FOI and R0 (here calculated from environmental covariates), number of repetitions for which to run model and obtain average outputs, environmental covariate data, fixed R0 values by region used when R0 is not a variable, and values of vaccine efficacy and severe and fatal case reporting probability used when these are not variables set via param_prop
```

The data_match_single() function is run to produce a set of modelled data matching the observed data, i.e.:

-Seroprevalence values for the same age group(s) in the same year(s)
-Numbers of reported cases and deaths in the same year(s)
-Outbreak occurence data for the same year(s)

```{r}
data1 <- data_match_single(param_prop,input_data,obs_sero_data,obs_case_data,obs_outbreak_data,const_list)
```

A data_match_multi() function exists to run data_match_single() for a series of sets of values of the input parameters. The inputs are the same except that the parameter values are input as a data frame containing one set of parameter values per line. 

```{r,eval=FALSE}
param_sets <- read.csv(file = paste(path.package("YellowFeverDynamics"),"/exdata/enviro_coeffs_example2.csv",sep = ""),header = TRUE)
data2 <- data_match_multi(param_sets,input_data,obs_sero_data,obs_case_data,obs_outbreak_data,const_list)
```

Data output from data_match_multi() can be plotted together with the observed data on which it is based, using the sero_match_graphs() and case_match_graphs() functions. Results from multiple parameter sets can be combined together in different ways [TBA].

```{r,eval=FALSE}
sero_graph <- sero_match_graphs(data2,obs_sero_data,plot_type="all",text_size=10,hide_observed=FALSE)
print(sero_graph[[1]])
```


```{r,eval=FALSE}
case_graph <- case_match_graphs(data2,obs_case_data,input_data,plot_type="mean",text_size=10,hide_observed=FALSE)
Rmisc::multiplot(case_graph$cases_graphs[[1]],case_graph$deaths_graphs[[1]])
```
